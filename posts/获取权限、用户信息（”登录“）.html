<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Aoike青池</title>

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://aoike.azurice.com/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<!--<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>-->
<!--<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>-->
<!--<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>-->

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    获取权限、用户信息（”登录“）.md
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        修改于 · 2021-01-23 02:25:23 · 发布于 · 2021-09-23 07:11:35
                    </time>
                </div>
                <div class="post-content">
                    <h2>云函数——获取 <em>openId</em></h2>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> cloud = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;wx-server-sdk&#x27;</span>)

<span class="hljs-comment">// 初始化 cloud</span>
cloud.init({
  <span class="hljs-comment">// API 调用都保持和云函数当前所在环境一致</span>
  <span class="hljs-attr">env</span>: cloud.DYNAMIC_CURRENT_ENV
})

<span class="hljs-comment">/**
 * 这个示例将经自动鉴权过的小程序用户 openid 返回给小程序端
 * 
 * event 参数包含小程序端调用传入的 data
 * 
 */</span>
<span class="hljs-built_in">exports</span>.main = <span class="hljs-keyword">async</span> (event, context) =&gt; {
  <span class="hljs-built_in">console</span>.log(event)
  <span class="hljs-built_in">console</span>.log(context)

  <span class="hljs-comment">// 可执行其他自定义逻辑</span>
  <span class="hljs-comment">// console.log 的内容可以在云开发云函数调用日志查看</span>

  <span class="hljs-comment">// 获取 WX Context (微信调用上下文)，包括 OPENID、APPID、及 UNIONID（需满足 UNIONID 获取条件）等信息</span>
  <span class="hljs-keyword">const</span> wxContext = cloud.getWXContext()

  <span class="hljs-keyword">return</span> {
    event,
    <span class="hljs-attr">openid</span>: wxContext.OPENID,
    <span class="hljs-attr">appid</span>: wxContext.APPID,
    <span class="hljs-attr">unionid</span>: wxContext.UNIONID,
    <span class="hljs-attr">env</span>: wxContext.ENV,
  }
}


</code></pre>
<h2>获取用户信息</h2>
<pre><code class="hljs language-mermaid">graph LR
	A[wx.getSetting] --无 scope.userInfo --&gt; B(Button open-type='getUserInfo') --&gt; C
	A --有 scope.userInfo --&gt; C[wx.getUserInfo]
	style B fill:#F0E68C
</code></pre>
<h3>1. <code><span class="hljs-selector-tag">wx</span><span class="hljs-selector-class">.getSetting</span>()</code></h3>
<p>获取用户的当前设置。<strong>返回值中只会出现小程序已经向用户请求过的<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/authorize.html">权限</a></strong>。</p>
<h4>参数</h4>
<ul>
<li>
<p><code><span class="hljs-attribute">withSubscriptions</span></code> <strong>Boolean</strong> 默认为 <code><span class="hljs-literal">false</span></code></p>
<p>是否同时获取用户订阅消息的订阅状态，默认不获取。注意：withSubscriptions 只返回用户勾选过订阅面板中的“总是保持以上选择，不再询问”的订阅消息。</p>
</li>
<li>
<p><code><span class="hljs-attribute">success</span></code> <strong>function</strong></p>
<p><strong>参数</strong></p>
<ul>
<li>
<p><code><span class="hljs-attribute">res</span></code> <strong>Object</strong></p>
<ul>
<li>
<p><code><span class="hljs-attribute">authSetting</span></code> <strong><a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/setting/AuthSetting.html">AuthSetting</a></strong></p>
<p>用户授权结果</p>
</li>
<li>
<p><code><span class="hljs-attribute">subscriptionsSetting</span></code> <strong><a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/setting/SubscriptionsSetting.html">SubscriptionsSetting</a></strong></p>
<p>用户订阅消息设置，接口参数<code><span class="hljs-attribute">withSubscriptions</span></code>值为<code><span class="hljs-literal">true</span></code>时才会返回。</p>
</li>
</ul>
</li>
<li>
<p><code><span class="hljs-built_in">fail</span></code> <strong>function</strong></p>
</li>
<li>
<p><code><span class="hljs-attribute">complete</span></code> <strong>function</strong></p>
</li>
</ul>
</li>
</ul>
<h4>AuthSetting</h4>
<h2>属性</h2>
<ul>
<li><code><span class="hljs-built_in">bool</span>ean scope.userInfo</code></li>
</ul>
<p>是否授权用户信息，对应接口 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html">wx.getUserInfo</a></p>
<ul>
<li><code><span class="hljs-built_in">bool</span>ean scope.userLocation</code></li>
</ul>
<p>是否授权地理位置，对应接口 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/location/wx.getLocation.html">wx.getLocation</a>, <a href="https://developers.weixin.qq.com/miniprogram/dev/api/location/wx.chooseLocation.html">wx.chooseLocation</a></p>
<ul>
<li><code><span class="hljs-built_in">bool</span>ean scope.address</code></li>
</ul>
<p>是否授权通讯地址，已取消此项授权，会默认返回 <code><span class="hljs-literal">true</span></code></p>
<ul>
<li><code><span class="hljs-built_in">bool</span>ean scope.invoiceTitle</code></li>
</ul>
<p>是否授权发票抬头，已取消此项授权，会默认返回 <code><span class="hljs-literal">true</span></code></p>
<ul>
<li><code><span class="hljs-built_in">bool</span>ean scope.invoice</code></li>
</ul>
<p>是否授权获取发票，已取消此项授权，会默认返回 <code><span class="hljs-literal">true</span></code></p>
<ul>
<li><code><span class="hljs-built_in">bool</span>ean scope.werun</code></li>
</ul>
<p>是否授权微信运动步数，对应接口 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/werun/wx.getWeRunData.html">wx.getWeRunData</a></p>
<ul>
<li><code><span class="hljs-built_in">boolean</span> scope.<span class="hljs-built_in">record</span></code></li>
</ul>
<p>是否授权录音功能，对应接口 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/media/recorder/wx.startRecord.html">wx.startRecord</a></p>
<ul>
<li><code><span class="hljs-built_in">bool</span>ean scope.writePhotosAlbum</code></li>
</ul>
<p>是否授权保存到相册 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.saveImageToPhotosAlbum.html">wx.saveImageToPhotosAlbum</a>, <a href="https://developers.weixin.qq.com/miniprogram/dev/api/media/video/wx.saveVideoToPhotosAlbum.html">wx.saveVideoToPhotosAlbum</a></p>
<ul>
<li><code><span class="hljs-built_in">boolean</span> scope.<span class="hljs-built_in">camera</span></code></li>
</ul>
<p>是否授权摄像头，对应<a href="https://developers.weixin.qq.com/miniprogram/dev/component/camera.html">camera</a>组件</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// 获取用户信息</span>
    wx.getSetting({
      <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (res.authSetting[<span class="hljs-string">&#x27;scope.userInfo&#x27;</span>]) {
          <span class="hljs-comment">// 已经授权，可以直接调用 getUserInfo 获取头像昵称，不会弹框</span>
          wx.getUserInfo({
            <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
              <span class="hljs-built_in">this</span>.setData({
                <span class="hljs-attr">avatarUrl</span>: res.userInfo.avatarUrl,
                <span class="hljs-attr">userInfo</span>: res.userInfo
              })
            }
          })
        }
      }
        
        
<span class="hljs-attr">onGetUserInfo</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.data.logged &amp;&amp; e.detail.userInfo) {
      <span class="hljs-built_in">this</span>.setData({
        <span class="hljs-attr">logged</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">avatarUrl</span>: e.detail.userInfo.avatarUrl,
        <span class="hljs-attr">userInfo</span>: e.detail.userInfo
      })
    }
  },
      

<span class="hljs-attr">onGetOpenid</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">// 调用云函数</span>
    wx.cloud.callFunction({
      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;login&#x27;</span>,
      <span class="hljs-attr">data</span>: {},
      <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;[云函数] [login] user openid: &#x27;</span>, res.result.openid)
        app.globalData.openid = res.result.openid
        wx.navigateTo({
          <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;../userConsole/userConsole&#x27;</span>,
        })
      },
      <span class="hljs-attr">fail</span>: <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&#x27;[云函数] [login] 调用失败&#x27;</span>, err)
        wx.navigateTo({
          <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;../deployFunctions/deployFunctions&#x27;</span>,
        })
      }
    })
  }
</code></pre>

                </div>
            </article>
        </div>

    </div>
</div>
</body>
</html>
